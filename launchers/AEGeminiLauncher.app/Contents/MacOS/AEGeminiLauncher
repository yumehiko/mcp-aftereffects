#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

show_error() {
    /usr/bin/osascript -e "display dialog \"$1\" buttons {\"OK\"} default button 1 with icon stop"
    exit 1
}

find_repo_root() {
    local dir="$SCRIPT_DIR"
    while [[ "$dir" != "/" && -n "$dir" ]]; do
        if [[ -f "$dir/server/fastmcp_server.py" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

REPO_ROOT="$(find_repo_root || true)"

if [[ -z "$REPO_ROOT" ]]; then
    show_error "リポジトリが見つかりませんでした。アプリは mcp-aftereffects リポジトリ内に配置してください。"
fi

LAUNCH_SCRIPT="$REPO_ROOT/scripts/launch_gemini_stack.sh"

if [[ ! -x "$LAUNCH_SCRIPT" ]]; then
    show_error "起動スクリプトが見つかりません。'scripts/launch_gemini_stack.sh' が存在し実行可能か確認してください。"
fi

/usr/bin/osascript - "$REPO_ROOT" "$LAUNCH_SCRIPT" <<'APPLESCRIPT'
on run argv
    set repoDir to item 1 of argv
    set launchScript to item 2 of argv
    set commandText to "cd " & quoted form of repoDir & " && " & quoted form of launchScript

    tell application "Terminal"
        activate
        do script commandText
    end tell
end run
APPLESCRIPT
