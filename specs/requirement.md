# 要件定義書: AfterEffects - LLM連携ツール

## 1. プロジェクト概要

### 1.1. 目的
自然言語による指示を通じて、Adobe AfterEffectsの動画編集作業（特にエクスプレッション作成）を支援するLLMエージェントを開発する。利用者は、複雑なスクリプトを手で書く代わりに、エージェントとの対話によって目的の動作を実現できる。

## 2. システム構成

### 2.1. アーキテクチャ
本システムは、以下のコンポーネントで構成される。

- **対話インターフェース (Gemini CLI):** ユーザーはGemini CLIを通じて、エージェントに自然言語で指示を与える。
- **LLMエージェント:** ユーザーの指示を解釈し、タスクを実行する。AfterEffectsを操作するための専用ツール（関数）群を持つ。
- **AfterEffects連携バックエンド:** AfterEffects内で動作し、エージェントからの命令を受け付けて実行する。

### 2.2. 連携方式
- エージェントとAfterEffects間の通信は、CEP (Common Extensibility Platform) 拡張機能として実装されたローカルサーバーを介して行う。
- 通信プロトコルはHTTPまたはWebSocketを採用し、リアルタイムな双方向通信を実現する。
- AfterEffects内にユーザーが直接操作するUIパネルは設けない。連携バックエンドはバックグラウンドで動作する。

## 3. 機能要件

### 3.1. ユーザー体験
- ユーザーは、AfterEffectsのプロジェクトを開いた状態で、別のターミナルウィンドウ（Gemini CLI）でエージェントとの対話を開始する。
- ユーザーは「レイヤーAをフェードインさせて」のように、抽象的な指示を出すことができる。
- エージェントは、必要に応じて追加情報を質問したり、現在のプロジェクトの状態（レイヤー構成など）を自ら取得してタスクを遂行する。
- エージェントによって生成・適用されたスクリプトは、AfterEffectsのプロジェクトに即時反映される。

### 3.2. エージェントが利用するツール（AfterEffects連携API）
エージェントは、AfterEffectsを操作するために以下のAPI（ツール）を利用できる必要がある。

#### 3.2.1. レイヤー情報の取得
- **機能:** 現在アクティブなコンポジション内の全レイヤーのリストを取得する。
- **取得する情報:**
    - レイヤー名
    - レイヤーID（一意の識別子）
    - レイヤーの種別（テキスト、シェイプ、平面、動画など）
    - その他、エージェントが判断に必要とする可能性のある基本的なプロパティ（例: 表示/非表示、ロック状態）

#### 3.2.2. プロパティ情報の取得
- **機能:** 指定したレイヤーが持つ、操作可能な全プロパティのツリー構造を取得する。
- **取得する情報:**
    - プロパティ名（例: `トランスフォーム > 位置`）
    - プロパティの内部的なパス（スクリプトから参照するための名前）
    - 現在の値
    - エクスプレッションが適用済みかどうか

#### 3.2.3. スクリプト（エクスプレッション）の適用
- **機能:** 指定したレイヤーの、指定したプロパティに対して、文字列として与えられたエクスプレッションを設定（書き込み・上書き）する。
- **エラーハンドリング:** エクスプレッションの適用時にAfterEffectsがエラーを返した場合、そのエラー内容をエージェントにフィードバックし、修正を促す仕組みを検討する。

## 4. 非機能要件

- **パフォーマンス:** エージェントとの対話やコマンド実行が、ストレスなく行える程度の応答速度を確保する。
- **セキュリティ:** ローカルサーバーは、外部からの不正なアクセスを防ぐよう、ローカルホストからの接続のみを受け付けるように構成する。
- **拡張性:** 将来的に、対応する操作（キーフレームの追加、エフェクトの適用など）をツールとして簡単に追加できるような設計を心がける。